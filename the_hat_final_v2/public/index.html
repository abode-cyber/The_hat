<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hat - ุฐุง ูุงุช</title>
    <link rel="stylesheet" href="style.css">
    <!-- ููุชุจุฉ Socket.io ูู CDN ูุถูุงู ุงูุชุญููู -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* ุดุงุดุฉ ุงูุชุญููู ุงูุฃูููุฉ */
        #initial-loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #333;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ุฎุชู ุงูุชุณููู */
        .delivered-stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            border: 5px solid #4CAF50;
            color: #4CAF50;
            font-size: 2rem;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 10px;
            opacity: 0.8;
            pointer-events: none;
            z-index: 10;
            background: rgba(0,0,0,0.7);
        }
    </style>
</head>
<body>

    <!-- ุดุงุดุฉ ุงูุชุญููู ุชุธูุฑ ุฃูู ุดูุก -->
    <div id="initial-loader">
        <div class="spinner"></div>
        <h3 style="color: var(--accent-color);">ุฌุงุฑู ุงูุงุชุตุงู ุจุงููุทุจุฎ...</h3>
    </div>

    <header>
        <div class="logo-container">
            <!-- ุงููููู ุญูู ูุง ูุญุด -->
            <img src="./logo.webp" alt="The Hat Logo" class="logo-img" onerror="this.style.display='none'; document.querySelector('.logo-container').innerText='THE HAT'">
        </div>
        <h1>THE HAT | ุฐุง ูุงุช</h1>
    </header>

    <div class="container">

        <!-- ================= ุตูุญุฉ ุงุฎุชูุงุฑ ุงููุฑุน ================= -->
        <div id="branch-page" class="page active">
            <h2 style="text-align: center; margin-bottom: 20px; color: #aaa;">ุงุฎุชุฑ ุงููุฑุน ุงูุฃูุฑุจ ูู</h2>
            
            <div class="branch-card" style="margin-bottom: 20px;">
                <button class="btn" onclick="selectBranch('okaz')">ูุฑุน ุนูุงุธ</button>
            </div>
            
            <div class="branch-card">
                <button class="btn" onclick="selectBranch('halqa')">ูุฑุน ุงูุญููุฉ</button>
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <p style="color: #666; font-size: 0.9rem;">ููุธูุ</p>
                <button onclick="showPage('admin-login')" style="background: none; border: none; color: #444; text-decoration: underline; cursor: pointer;">ุฏุฎูู ุงููุทุจุฎ</button>
            </div>
        </div>

        <!-- ================= ุตูุญุฉ ุงููููู ================= -->
        <div id="menu-page" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 id="selected-branch-title">ุงููููู</h2>
                <button onclick="showPage('branch-page')" style="background: none; border: none; color: #aaa; cursor: pointer;">ุชุบููุฑ ุงููุฑุน</button>
            </div>

            <div id="menu-items">
                <!-- ุงูุฃุตูุงู ุจุชูุฒู ููุง ุจุงูุฌุงูุงุณูุฑูุจุช -->
            </div>

            <!-- ุงูุณูุฉ ุงูุนุงุฆูุฉ -->
            <div id="cart-float" class="cart-float" style="display: none;" onclick="showPage('checkout-page')">
                <span id="cart-count">0 ููุชุฌุงุช</span>
                <span id="cart-total">0 ุฑูุงู</span>
                <span>ุฅุชูุงู ุงูุทูุจ &larr;</span>
            </div>
        </div>

        <!-- ================= ุตูุญุฉ ุงูุฏูุน ูุฅููุงู ุงูุทูุจ ================= -->
        <div id="checkout-page" class="page">
            <button onclick="showPage('menu-page')" class="btn btn-secondary" style="margin-bottom: 20px;">&rarr; ุฑุฌูุน ูููููู</button>
            
            <h2 style="margin-bottom: 20px; color: var(--accent-color);">ููุฎุต ุงูุทูุจ</h2>
            <div id="checkout-items" style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <!-- ุชูุงุตูู ุงูุณูุฉ ููุง -->
            </div>

            <h3 style="margin-bottom: 15px;">ุจูุงูุงุชู ูุง ุบุงูู</h3>
            <form id="order-form" onsubmit="submitOrder(event)">
                <div class="form-group">
                    <label>ุงูุงุณู ุงููุฑูู</label>
                    <input type="text" id="customer-name" required placeholder="ูุซูุงู: ูุญูุฏ ุงูุนุชูุจู">
                    <small id="name-error" style="color: var(--danger-color); display: none;">ุงูุงุณู ูุทููุจ ูุง ุบุงูู</small>
                </div>
                <div class="form-group">
                    <label>ุฑูู ุงูุฌูุงู (ูุงุฒู ูุจุฏุฃ ุจู 05 ููููู 10 ุฃุฑูุงู)</label>
                    <input type="tel" id="customer-phone" required placeholder="05xxxxxxxx" maxlength="10">
                    <small id="phone-error" style="color: var(--danger-color); display: none;">ุฑูู ุงูุฌูุงู ูุงุฒู ูุจุฏุฃ ุจู 05 ููููู 10 ุฃุฑูุงู</small>
                </div>
                <div class="form-group">
                    <label>ููุน ูููุฏูู ุงูุณูุงุฑุฉ (ุนุดุงู ูุนุฑูู)</label>
                    <input type="text" id="car-info" required placeholder="ูุซูุงู: ูุงูุฑู ุจูุถุงุก 2020">
                </div>
                
                <button type="submit" id="submit-btn" class="btn">
                    <span id="btn-text">ุชุฃููุฏ ุงูุทูุจ (ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู)</span>
                    <span id="btn-loader" style="display: none;">ุฌุงุฑู ุงูุฅุฑุณุงู... โณ</span>
                </button>
            </form>
        </div>

        <!-- ================= ุตูุญุฉ ุงููุงุชูุฑุฉ (ุชุชุจุน ุงูุทูุจ) ================= -->
        <div id="invoice-page" class="page">
            <div style="text-align: center; padding: 30px 0;">
                <div style="font-size: 4rem; color: var(--success-color); margin-bottom: 10px;">&#10004;</div>
                <h2 style="color: var(--accent-color);">ุชู ุงุณุชูุงู ุทูุจู ุจูุฌุงุญ!</h2>
                <p style="color: #aaa; margin-top: 10px;">ุฑูู ุงูุทูุจ: <span id="invoice-id" style="color: white; font-weight: bold;">#</span></p>
            </div>

            <div class="order-card" style="text-align: center;">
                <p>ุญุงูุฉ ุงูุทูุจ ุงูุญุงููุฉ:</p>
                <h1 id="invoice-status" style="font-size: 2rem; margin: 15px 0; color: var(--accent-color);">ุฌุงุฑู ุงูุงูุชุธุงุฑ...</h1>
                <p style="font-size: 0.9rem; color: #888;">ุฎููู ูู ูุงูุตูุญุฉุ ุจุชุชุญุฏุซ ุชููุงุฆูุงู ููุง ูุฌูุฒ ุทูุจู</p>
            </div>

            <div style="margin-top: 30px;">
                <h3 style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px;">ุชูุงุตูู ุงููุงุชูุฑุฉ</h3>
                <div id="invoice-details"></div>
                <div style="margin-top: 15px; font-weight: bold; font-size: 1.2rem; text-align: left;">
                    ุงููุฌููุน: <span id="invoice-total" style="color: var(--accent-color);">0</span> ุฑูุงู
                </div>
            </div>
            
            <button onclick="startNewOrder()" class="btn btn-secondary" style="margin-top: 30px;">ุทูุจ ุฌุฏูุฏ</button>
        </div>

        <!-- ================= ุตูุญุฉ ุฏุฎูู ุงูุฃุฏูู ================= -->
        <div id="admin-login" class="page">
            <h2 style="text-align: center; margin-bottom: 20px;">ุฏุฎูู ุงููุทุจุฎ / ุงููุงุดูุฑ</h2>
            <div class="form-group">
                <label>ุงูุฑูุฒ ุงูุณุฑู</label>
                <input type="password" id="admin-pin" placeholder="ุฃุฏุฎู ุงูุฑูุฒ" style="text-align: center; letter-spacing: 5px; font-size: 1.5rem;">
            </div>
            <button onclick="checkAdminPin()" class="btn">ุฏุฎูู</button>
            <button onclick="showPage('branch-page')" class="btn btn-secondary">ุฑุฌูุน</button>
        </div>

        <!-- ================= ุตูุญุฉ ููุญุฉ ุงูุชุญูู (ุงููุทุจุฎ) ================= -->
        <div id="admin-dashboard" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                <h2>๐จโ๐ณ ุงููุทุจุฎ (ุงูุทูุจุงุช ุงูุญูุฉ)</h2>
                <div>
                    <button onclick="enableSound()" id="sound-btn" style="background: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-left: 5px;">๐ ุชูุนูู ุงูุตูุช</button>
                    <button onclick="showPage('branch-page')" style="background: #333; color: white; border: none; padding: 5px 10px; border-radius: 4px;">ุฎุฑูุฌ</button>
                </div>
            </div>

            <div id="admin-orders-list">
                <p style="text-align: center; color: #666; margin-top: 50px;">ูุง ุชูุฌุฏ ุทูุจุงุช ุญุงููุงู...</p>
            </div>
        </div>

    </div>

    <!-- ููุฏุงู ุงุฎุชูุงุฑ ุงููููุน -->
    <div id="location-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px; color: var(--accent-color);">ุชูุฌูู ูููุฑุน</h3>
            <p style="margin-bottom: 20px;">ุชุจู ููุชุญ ูู ูููู ูุงุจ ููุง ุชุฏู ุงูุทุฑููุ</p>
            <button id="maps-btn" class="btn">ูุฏูู ูููููุน (Google Maps)</button>
            <button onclick="closeModalAndGoToMenu()" class="btn btn-secondary">ุฃุนุฑู ุงููููุนุ ููู ุงูุทูุจ</button>
        </div>
    </div>

    <!-- ุตูุช ุงูุชูุจูู (ูุฎูู) -->
    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // ================= ุงูุจูุงูุงุช (ุงููููู ุงูุฌุฏูุฏ - ุงููุณุฎุฉ ุงูููุงุฆูุฉ) =================
        const menuItems = [
            // 1. ูุณู ุงููุฌุจุงุช ูุงูุณุงูุฏูุชุดุงุช
            { id: 1, name: "ูุงุช ูุฌุจุฉ ูุญู (950 cal)", price: 23, category: "ูุฌุจุงุช" },
            { id: 2, name: "ูุงุช ูุฌุจุฉ ุฏุฌุงุฌ (830 cal)", price: 21, category: "ูุฌุจุงุช" },
            { id: 3, name: "ูุงุช ุดูุณ ูุญู (490 cal)", price: 16, category: "ุณุงูุฏูุชุดุงุช" },
            { id: 4, name: "ูุงุช ุดูุณ ุฏุฌุงุฌ (400 cal)", price: 14, category: "ุณุงูุฏูุชุดุงุช" },
            { id: 5, name: "ูุงุช ุจุฑุฌุฑ ูุญู (450 cal)", price: 14, category: "ุณุงูุฏูุชุดุงุช" },
            { id: 6, name: "ูุงุช ุจุฑุฌุฑ ุฏุฌุงุฌ (360 cal)", price: 12, category: "ุณุงูุฏูุชุดุงุช" },
            { id: 7, name: "ูุงุช ุณุชูู (ูุญู/ุฏุฌุงุฌ)", price: 13, category: "ุณุงูุฏูุชุดุงุช" },
            { id: 8, name: "ูุงุช ุณุชูู ูุฌุจุฉ", price: 23, category: "ูุฌุจุงุช" },
            { id: 9, name: "ูุงุช ุญุณูู (350 cal)", price: 16, category: "ุณุงูุฏูุชุดุงุช" },
            { id: 10, name: "ูุงุช ุญุณูู ูุฌุจุฉ", price: 18, category: "ูุฌุจุงุช" },
            { id: 11, name: "ูุงุช ุณุจูุดู ุญุณูู (390 cal)", price: 18, category: "ุณุงูุฏูุชุดุงุช" },

            // 2. ูุณู ูุงุช ุจุทุงุทุณ
            { id: 12, name: "ุจุทุงุทุณ ููุฏุฌุฑ (200 cal)", price: 9, category: "ุจุทุงุทุณ" },
            { id: 13, name: "ุจุทุงุทุณ ุจุงูุจุตู ุงูููุฑูุด (220 cal)", price: 11, category: "ุจุทุงุทุณ" },
            { id: 14, name: "ุจุทุงุทุณ ุจุงููุญู ุงูููุฑูู (245 cal)", price: 12, category: "ุจุทุงุทุณ" },
            { id: 15, name: "ุจุทุงุทุณ ููุนุจุงุช (200 cal)", price: 10, category: "ุจุทุงุทุณ" },
            { id: 16, name: "ุจุทุงุทุณ ุญููุฉ ูุน ุตูุต ุชูุณุงุณ (130 cal)", price: 11, category: "ุจุทุงุทุณ" },
            { id: 17, name: "ุจุทุงุทุณ ุจุงูุฏุฌุงุฌ ุงูููุฑูู (238 cal)", price: 12, category: "ุจุทุงุทุณ" },

            // 3. ูุณู ุงูุฅุถุงูุงุช
            { id: 18, name: "ุตูุต ุฐุง ูุงุช", price: 2, category: "ุฅุถุงูุงุช" },
            { id: 19, name: "ุตูุต ุชูุณุงุณ", price: 2, category: "ุฅุถุงูุงุช" },
            { id: 20, name: "ุตูุต ุฌุจู", price: 2, category: "ุฅุถุงูุงุช" },
            { id: 21, name: "ููุงุจููู", price: 2, category: "ุฅุถุงูุงุช" },
            { id: 22, name: "ุดุฑูุญุฉ ุฌุจู", price: 2, category: "ุฅุถุงูุงุช" },
            { id: 23, name: "ุจุตู ููุฑูุด", price: 2, category: "ุฅุถุงูุงุช" },
            { id: 24, name: "ุดูุชูุณ", price: 2, category: "ุฅุถุงูุงุช" },

            // 4. ูุณู ุงููุดุฑูุจุงุช
            { id: 25, name: "ุจูุจุณู", price: 4, category: "ูุดุฑูุจุงุช" },
            { id: 26, name: "ุฏูู", price: 4, category: "ูุดุฑูุจุงุช" },
            { id: 27, name: "ุณูู ุฃุจ", price: 4, category: "ูุดุฑูุจุงุช" },
            { id: 28, name: "ููุฑูุฏุง", price: 4, category: "ูุดุฑูุจุงุช" },
            { id: 29, name: "ูุงุก", price: 1, category: "ูุดุฑูุจุงุช" }
        ];

        // ================= ุงููุชุบูุฑุงุช ุงูุนุงูุฉ =================
        let cart = [];
        let selectedBranch = '';
        let myOrderId = localStorage.getItem('myOrderId'); // ุงุณุชุฑุฌุงุน ุฑูู ุงูุทูุจ ุงููุญููุธ
        let allOrders = [];
        
        // ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ
        const socket = io();

        // ================= ุฅุฏุงุฑุฉ ุงูุตูุญุงุช =================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // ุญูุธ ุงูุตูุญุฉ ุงูุญุงููุฉ ุนุดุงู ูู ุณูู ุชุญุฏูุซ
            if (pageId !== 'initial-loader') {
                localStorage.setItem('currentPage', pageId);
            }
        }

        // ================= ููุทู ุงูุชุทุจูู =================
        function selectBranch(branch) {
            selectedBranch = branch;
            localStorage.setItem('selectedBranch', branch); // ุญูุธ ุงููุฑุน
            
            document.getElementById('selected-branch-title').innerText = 
                branch === 'okaz' ? 'ูููู ูุฑุน ุนูุงุธ' : 'ูููู ูุฑุน ุงูุญููุฉ';
            
            renderMenu();
            
            // ูุชุญ ุงูููุฏุงู ุญู ุงููููุน
            const modal = document.getElementById('location-modal');
            const mapsBtn = document.getElementById('maps-btn');
            
            if (branch === 'okaz') {
                mapsBtn.onclick = () => window.open('https://maps.app.goo.gl/XYZ', '_blank');
            } else {
                mapsBtn.onclick = () => window.open('https://maps.app.goo.gl/ABC', '_blank');
            }
            
            modal.style.display = 'flex';
        }

        function closeModalAndGoToMenu() {
            document.getElementById('location-modal').style.display = 'none';
            showPage('menu-page');
        }

        function renderMenu() {
            const container = document.getElementById('menu-items');
            container.innerHTML = '';
            
            const categories = [...new Set(menuItems.map(item => item.category))];
            
            categories.forEach(cat => {
                const catTitle = document.createElement('h3');
                catTitle.style.color = 'var(--accent-color)';
                catTitle.style.marginTop = '20px';
                catTitle.style.borderBottom = '1px solid #333';
                catTitle.innerText = cat;
                container.appendChild(catTitle);
                
                menuItems.filter(i => i.category === cat).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'menu-item';
                    div.innerHTML = `
                        <div>
                            <div style="font-weight: bold;">${item.name}</div>
                            <div style="color: var(--accent-color);">${item.price} ุฑูุงู</div>
                        </div>
                        <button class="btn" style="width: auto; padding: 5px 15px;" onclick="addToCart(${item.id})">ุฅุถุงูุฉ +</button>
                    `;
                    container.appendChild(div);
                });
            });
        }

        function addToCart(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            cart.push(item);
            updateCartUI();
        }

        function updateCartUI() {
            const float = document.getElementById('cart-float');
            const count = document.getElementById('cart-count');
            const total = document.getElementById('cart-total');
            
            if (cart.length > 0) {
                float.style.display = 'flex';
                count.innerText = `${cart.length} ููุชุฌุงุช`;
                const sum = cart.reduce((a, b) => a + b.price, 0);
                total.innerText = `${sum} ุฑูุงู`;
                
                // ุชุญุฏูุซ ุตูุญุฉ ุงูุฏูุน ููุงู
                const checkoutItems = document.getElementById('checkout-items');
                checkoutItems.innerHTML = cart.map(item => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                        <span>${item.name}</span>
                        <span>${item.price} ุฑูุงู</span>
                    </div>
                `).join('');
                
                checkoutItems.innerHTML += `
                    <div style="margin-top: 15px; font-weight: bold; font-size: 1.2rem; text-align: left;">
                        ุงููุฌููุน: <span style="color: var(--accent-color);">${sum}</span> ุฑูุงู
                    </div>
                `;
            } else {
                float.style.display = 'none';
            }
        }

        function submitOrder(e) {
            e.preventDefault();
            
            const name = document.getElementById('customer-name').value;
            const phone = document.getElementById('customer-phone').value;
            const car = document.getElementById('car-info').value;
            
            // ุชุญูู ุจุณูุท
            if (!name) {
                document.getElementById('name-error').style.display = 'block';
                return;
            }
            if (!phone.startsWith('05') || phone.length !== 10) {
                document.getElementById('phone-error').style.display = 'block';
                return;
            }
            
            // ุชุดุบูู ุงูููุฏุฑ
            const btn = document.getElementById('submit-btn');
            btn.disabled = true;
            document.getElementById('btn-text').style.display = 'none';
            document.getElementById('btn-loader').style.display = 'inline';
            
            const orderData = {
                customerName: name,
                phone: phone,
                carInfo: car,
                branch: selectedBranch,
                items: cart,
                total: cart.reduce((a, b) => a + b.price, 0),
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            
            // ุฅุฑุณุงู ููุณูุฑูุฑ
            socket.emit('new-order', orderData);
        }

        // ================= ุฃุฏูู / ูุทุจุฎ =================
        function checkAdminPin() {
            const pin = document.getElementById('admin-pin').value;
            if (pin === '1234') {
                showPage('admin-dashboard');
                renderAdminOrders(allOrders);
            } else {
                alert('ุงูุฑูุฒ ุบูุท ูุง ุงูุญุจูุจ!');
            }
        }

        function getShortId(longId) {
            return longId.slice(0, 4).toUpperCase();
        }

        function renderAdminOrders(orders) {
            const list = document.getElementById('admin-orders-list');
            
            // ููุชุฑุฉ ุงูุทูุจุงุช ุงููุคุฑุดูุฉ (ูุง ูุนุฑุถูุง ูู ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ)
            const activeOrders = orders.filter(o => o.status !== 'archived');
            
            if (activeOrders.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; margin-top: 50px;">ูุง ุชูุฌุฏ ุทูุจุงุช ูุดุทุฉ ุญุงููุงู...</p>';
                return;
            }
            
            // ุชุฑุชูุจ: ุงูุฌุฏูุฏ ููู
            activeOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            list.innerHTML = activeOrders.map(order => {
                const timeAgo = Math.floor((new Date() - new Date(order.timestamp)) / 60000);
                
                // ุชุญุฏูุฏ ููู ุงููุฑุช ุจูุงุกู ุนูู ุงูุญุงูุฉ
                let cardStyle = '';
                let stamp = '';
                
                if (order.status === 'delivered') {
                    cardStyle = 'border: 2px solid #4CAF50; background: #1a331a;'; // ุฃุฎุถุฑ ุบุงูู
                    stamp = '<div class="delivered-stamp">ุชู ุงูุชุณููู</div>';
                } else if (order.status === 'ready') {
                    cardStyle = 'border: 2px solid var(--accent-color);';
                }

                return `
                <div class="order-card" style="position: relative; ${cardStyle}">
                    ${stamp}
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>
                            <h3 style="margin: 0; color: var(--accent-color);">${order.customerName}</h3>
                            <div style="font-size: 0.9rem; color: #fff;">๐ฑ ${order.phone}</div>
                            <div style="font-size: 0.9rem; color: #aaa;">๐ ${order.carInfo}</div>
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: bold; font-size: 1.2rem;">#${getShortId(order.id)}</div>
                            <div style="font-size: 0.8rem; color: #666;">ููุฐ ${timeAgo} ุฏูููุฉ</div>
                            <div style="font-size: 0.8rem; color: var(--accent-color); margin-top: 5px;">${order.branch === 'okaz' ? 'ุนูุงุธ' : 'ุงูุญููุฉ'}</div>
                        </div>
                    </div>

                    <div style="background: #222; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                        ${order.items.map(item => `
                            <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 3px;">
                                <span>${item.name}</span>
                                <span>${item.price}</span>
                            </div>
                        `).join('')}
                        <div style="border-top: 1px solid #444; margin-top: 5px; padding-top: 5px; font-weight: bold; text-align: left;">
                            ุงูุฅุฌูุงูู: ${order.total} ุฑูุงู
                        </div>
                    </div>

                    ${order.status !== 'delivered' ? `
                    <div class="action-buttons">
                        ${order.status === 'pending' ? `<button onclick="updateStatus('${order.id}', 'preparing')" class="btn" style="background: #2196F3;">๐จโ๐ณ ุฌุงุฑู ุงูุชุญุถูุฑ</button>` : ''}
                        ${order.status === 'preparing' ? `<button onclick="updateStatus('${order.id}', 'ready')" class="btn" style="background: var(--success-color);">โ ุฌุงูุฒ ููุงุณุชูุงู</button>` : ''}
                        ${order.status === 'ready' ? `<button onclick="updateStatus('${order.id}', 'delivered')" class="btn" style="background: #4CAF50;">๐ค ุชู ุชุณููู ุงูุนููู</button>` : ''}
                    </div>
                    ` : ''}
                </div>
            `;
            }).join('');
        }

        function getStatusText(status) {
            if (status === 'pending') return 'ุทูุจ ุฌุฏูุฏ ๐';
            if (status === 'preparing') return 'ุฌุงุฑู ุงูุชุฌููุฒ ๐ณ';
            if (status === 'ready') return 'ุฌุงูุฒ ููุงุณุชูุงู โ';
            if (status === 'delivered') return 'ุชู ุงูุงุณุชูุงู ๐';
            return status;
        }

        function updateStatus(orderId, status) {
            // ุฅุฐุง ุงูุญุงูุฉ ุตุงุฑุช "ุชู ุงูุชุณููู"ุ ูุฃุฑุดู ุงูุทูุจ ุจุนุฏ 5 ุซูุงูู ุนุดุงู ูุฎุชูู ูู ุงูุดุงุดุฉ
            socket.emit('update-status', { orderId, status });
            
            if (status === 'delivered') {
                setTimeout(() => {
                    socket.emit('update-status', { orderId, status: 'archived' });
                }, 5000); // 5 ุซูุงูู ุนุดุงู ูุดูู ุงูุฎุชู ุงูุฃุฎุถุฑ
            }
        }

        function enableSound() {
            const audio = document.getElementById('notification-sound');
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
                document.getElementById('sound-btn').innerText = 'โ ุงูุตูุช ููุนู';
                document.getElementById('sound-btn').style.color = '#4CAF50';
            }).catch(e => alert('ูุงุฒู ุชุถุบุท ุนุดุงู ุงููุชุตูุญ ูุณูุญ ุจุงูุตูุช'));
        }
        
        function startNewOrder() {
            localStorage.removeItem('myOrderId');
            myOrderId = null;
            cart = [];
            showPage('branch-page');
        }

        // ================= Socket.io Listeners (ุงูููุจ ุงููุงุจุถ) =================
        
        socket.on('connect', () => {
            console.log('Connected to server');
            // ูุฎูู ุดุงุดุฉ ุงูุชุญููู ููุง ูุชุตู
            document.getElementById('initial-loader').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('initial-loader').style.display = 'none';
            }, 500);

            // ุงุณุชุนุงุฏุฉ ุงูุญุงูุฉ ุนูุฏ ุงูุชุญุฏูุซ
            const savedPage = localStorage.getItem('currentPage');
            const savedBranch = localStorage.getItem('selectedBranch');
            
            if (savedBranch) {
                selectedBranch = savedBranch;
                renderMenu(); // ุนุดุงู ูุนุจู ุงููููู ูู ูุงู ูู ุตูุญุฉ ุงููููู
            }

            // ูู ุงูุฒุจูู ุนูุฏู ุทูุจุ ูุญุฏุซ ุญุงูุชู ูููุฏูู ูููุงุชูุฑุฉ
            if (myOrderId) {
                // ูุทูุจ ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ูุฐุง ุชุญุฏูุฏุงู
                socket.emit('request-order-status', myOrderId);
            } else if (savedPage && savedPage !== 'invoice-page') {
                // ูู ูุง ุนูุฏู ุทูุจุ ูุฑุฌุนู ูุตูุญุชู ุงููุญููุธุฉ (ุฅูุง ูู ูุงูุช ูุงุชูุฑุฉ ููู ูุง ุนูุฏู ุทูุจ)
                showPage(savedPage);
            }
        });

        // ูู ุงููุทุน ุงูุงุชุตุงูุ ูุฑุฌุน ุดุงุดุฉ ุงูุชุญููู ุนุดุงู ูุง ูุนูู ุงูุฒุจูู
        socket.on('disconnect', () => {
            document.getElementById('initial-loader').style.display = 'flex';
            document.getElementById('initial-loader').style.opacity = '1';
            document.querySelector('#initial-loader h3').innerText = 'ุงููุทุน ุงูุงุชุตุงู... ุฌุงุฑู ุงููุญุงููุฉ...';
        });

        // ุฃูู ูุง ูุดุจูุ ูุณุชูู ุงูุทูุจุงุช ุงูููุฌูุฏุฉ
        socket.on('initial-orders', (orders) => {
            console.log('Initial orders received:', orders.length);
            allOrders = orders; 
            renderAdminOrders(orders);
        });

        // ุชุฃููุฏ ุงุณุชูุงู ุงูุทูุจ ููุฒุจูู (ุนุดุงู ูููู ุงูููุฏููู)
        socket.on('order-confirmed', (orderId) => {
            console.log('ุชู ุชุฃููุฏ ุงูุทูุจ ูู ุงูุณูุฑูุฑ ุจุฑูู:', orderId);
            myOrderId = orderId; 
            localStorage.setItem('myOrderId', orderId); // ุญูุธ ุฏุงุฆู ูุฑูู ุงูุทูุจ
            
            // ูููู ุงูููุฏููู ููููู ูููุงุชูุฑุฉ
            const btn = document.getElementById('submit-btn');
            if (btn) {
                btn.disabled = false;
                document.getElementById('btn-text').style.display = 'inline';
                document.getElementById('btn-loader').style.display = 'none';
            }
            
            document.getElementById('invoice-id').innerText = '#' + getShortId(orderId);
            showPage('invoice-page'); 
        });

        // ุงุณุชูุจุงู ุชุญุฏูุซ ุญุงูุฉ ุทูุจ ูุนูู (ููุฒุจูู)
        socket.on('order-status-update', (orderData) => {
            // ุฅุฐุง ูุฐุง ุทูุจูุ ุฃุญุฏุซ ุงููุงุชูุฑุฉ
            if (orderData.id === myOrderId) {
                updateInvoiceUI(orderData);
                
                // ุฅุฐุง ููุช ูู ุตูุญุฉ ุซุงููุฉุ ูุฏููู ูููุงุชูุฑุฉ (ูุซูุงู ูู ุญุฏุซุช ุงูุตูุญุฉ)
                if (!document.getElementById('invoice-page').classList.contains('active')) {
                    showPage('invoice-page');
                }
            }
        });

        // ููุง ูุฌู ุชุญุฏูุซ ุนูู ุงูุทูุจุงุช (ุทูุจ ุฌุฏูุฏุ ุชุบููุฑ ุญุงูุฉุ ุญุฐู)
        socket.on('order-update', (orders) => {
            console.log('ูุตู ุชุญุฏูุซ ุฌุฏูุฏ ููุทูุจุงุช:', orders.length);
            
            // ูุดูู ูู ููู ุทูุจ ุฌุฏูุฏ ุนุดุงู ูุดุบู ุงูุตูุช
            if (orders.length > allOrders.length) {
                const audio = document.getElementById('notification-sound');
                audio.play().catch(e => console.log('ูุงุฒู ุชูุงุนู ุนุดุงู ุงูุตูุช ูุดุชุบู'));
            }
            
            allOrders = orders; 
            renderAdminOrders(orders);

            // ูู ุงูุฒุจูู ูุงุชุญ ุงููุงุชูุฑุฉุ ูุญุฏุซ ุจูุงูุงุชู
            if (myOrderId) {
                const myOrder = orders.find(o => o.id === myOrderId);
                if (myOrder) {
                    updateInvoiceUI(myOrder);
                }
            }
        });

        function updateInvoiceUI(order) {
            // ุชุญุฏูุซ ุฑูู ุงูุทูุจ
            document.getElementById('invoice-id').innerText = '#' + getShortId(order.id);
            
            // ุชุญุฏูุซ ุงูุญุงูุฉ
            document.getElementById('invoice-status').innerText = getStatusText(order.status);
            
            // ุชุญุฏูุซ ุงูุชูุงุตูู (ุนุดุงู ูู ุญุฏุซ ุงูุตูุญุฉ ูุง ุชุฎุชูู)
            const detailsDiv = document.getElementById('invoice-details');
            detailsDiv.innerHTML = order.items.map(item => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                    <span>${item.name}</span>
                    <span>${item.price} ุฑูุงู</span>
                </div>
            `).join('');
            
            // ุชุญุฏูุซ ุงููุฌููุน
            document.getElementById('invoice-total').innerText = order.total;
        }

    </script>
</body>
</html>
